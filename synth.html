<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Synthesizer & Drum Machine</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js (Web Audio Library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Import Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
        }

        /* Custom styles for sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #374151; /* gray-700 */
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8b5cf6; /* purple-500 */
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8b5cf6; /* purple-500 */
            cursor: pointer;
        }
        
        /* Sequencer button styles */
        .seq-btn {
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            transition: background-color 0.05s ease;
        }
        .seq-btn:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .seq-btn.active {
            background-color: #8b5cf6; /* purple-500 */
            box-shadow: 0 0 10px #8b5cf6;
        }
        .seq-btn.playing, .track-label.playing {
            background-color: #a78bfa; /* purple-400 */
            border-color: #ecfdf5; /* emerald-50 */
            color: #111827; /* gray-900 */
        }
        
        .track-label {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #4b5563; /* gray-600 */
            transition: background-color 0.1s ease;
            cursor: pointer;
        }
        .track-label:hover {
            background-color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <!-- Header -->
    <h1 class="text-4xl font-bold my-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">
        Web Synthesizer
    </h1>

    <!-- Master Controls -->
    <div class="w-full max-w-6xl bg-gray-800 p-4 rounded-lg shadow-lg mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Transport -->
            <div class="flex items-center justify-center gap-4">
                <button id="playStopButton" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-md text-xl">
                    Play
                </button>
            </div>

            <!-- Sliders -->
            <div class="space-y-4">
                <label for="bpmSlider" class="flex justify-between text-sm font-medium text-gray-400">
                    <span>BPM</span>
                    <span id="bpmValue" class="font-bold text-purple-400">120</span>
                </label>
                <input type="range" id="bpmSlider" min="60" max="180" value="120" class="w-full">
            </div>
            
            <div class="space-y-4">
                <label for="panSlider" class="flex justify-between text-sm font-medium text-gray-400">
                    <span>Pan (L/R Fade)</span>
                    <span id="panValue" class="font-bold text-purple-400">Center</span>
                </label>
                <input type="range" id="panSlider" min="-1" max="1" value="0" step="0.01" class="w-full">
            </div>
            
            <div class="space-y-4 md:col-start-2">
                 <label for="octaveSlider" class="flex justify-between text-sm font-medium text-gray-400">
                    <span>Master Octave</span>
                    <span id="octaveValue" class="font-bold text-purple-400">0</span>
                </label>
                <input type="range" id="octaveSlider" min="-2" max="2" value="0" step="1" class="w-full">
            </div>
            
            <!-- Loading Status -->
            <!-- Removed loading indicator as it's no longer needed -->
        </div>
    </div>

    <!-- Sequencer Grid -->
    <div id="sequencer" class="w-full max-w-6xl overflow-x-auto">
        <!-- Grid will be generated by JavaScript -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const playStopButton = document.getElementById('playStopButton');
            const bpmSlider = document.getElementById('bpmSlider');
            const bpmValue = document.getElementById('bpmValue');
            const panSlider = document.getElementById('panSlider');
            const panValue = document.getElementById('panValue');
            const octaveSlider = document.getElementById('octaveSlider');
            const octaveValue = document.getElementById('octaveValue');
            const sequencerGrid = document.getElementById('sequencer');

            // --- Constants ---
            const NUM_STEPS = 16;
            
            // --- State ---
            let gridState = []; // 2D array for sequencer state
            let currentStep = 0;
            let synths = {};
            let masterPanner;

            /**
             * Initializes the audio context, loads sounds, and sets up synths.
             */
            async function setupAudio() {
                await Tone.start();
                console.log("Audio Context Started");

                // --- Master Effects ---
                masterPanner = new Tone.Panner(0).toDestination();

                // --- Synths (Techno Setup) ---
                synths['808 Kick'] = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 10,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' }
                }).connect(masterPanner);
                
                synths['909 Kick'] = new Tone.MembraneSynth({
                    pitchDecay: 0.01,
                    octaves: 6,
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.1 }
                }).connect(masterPanner);

                synths['909 Snare'] = new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0 }
                }).connect(masterPanner);

                synths['909 Clap'] = new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.05 }
                }).connect(masterPanner);


                synths['909 Hat-C'] = new Tone.MetalSynth({ // Closed Hat
                    frequency: 250,
                    envelope: { attack: 0.001, decay: 0.03, sustain: 0 },
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                }).connect(masterPanner);
                
                synths['909 Hat-O'] = new Tone.MetalSynth({ // Open Hat
                    frequency: 250,
                    envelope: { attack: 0.001, decay: 0.3, sustain: 0 }, // Longer decay
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                }).connect(masterPanner);
                
                synths['Techno Tom L'] = new Tone.MembraneSynth({
                    pitchDecay: 0.1,
                    octaves: 2,
                    envelope: { attack: 0.001, decay: 0.3, sustain: 0.01 }
                }).connect(masterPanner);
                
                synths['Techno Tom H'] = new Tone.MembraneSynth({
                    pitchDecay: 0.1,
                    octaves: 3,
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.01 }
                }).connect(masterPanner);
                
                synths['Techno Stab'] = new Tone.FMSynth({
                    harmonicity: 1.01,
                    modulationIndex: 10,
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.01 },
                    modulationEnvelope: { attack: 0.01, decay: 0.1, sustain: 0.01 }
                }).connect(masterPanner);
                
                synths['Bass'] = new Tone.MonoSynth({
                    oscillator: { type: 'fatsawtooth' },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 },
                    filterEnvelope: { attack: 0.01, decay: 0.1, sustain: 0.2, baseFrequency: 200, octaves: 2 }
                }).connect(masterPanner);

                console.log("Built-in techno synths created!");
                
                // --- Track Definitions ---
                const trackDefs = [
                    { name: '808 Kick', sound: '808 Kick' },
                    { name: '909 Kick', sound: '909 Kick' },
                    { name: '909 Snare', sound: '909 Snare' },
                    { name: '909 Clap', sound: '909 Clap' },
                    { name: '909 Hat-C', sound: '909 Hat-C' },
                    { name: '909 Hat-O', sound: '909 Hat-O' },
                    { name: 'Tom L', sound: 'Techno Tom L' },
                    { name: 'Tom H', sound: 'Techno Tom H' },
                    { name: 'Stab', sound: 'Techno Stab' },
                    { name: 'Bass', sound: 'Bass' },
                ];
                
                return trackDefs;
            }

            /**
             * Creates the HTML sequencer grid.
             * @param {Array} tracks - The track definitions.
             */
            function createGrid(tracks) {
                sequencerGrid.innerHTML = ''; // Clear existing grid
                
                // Create a container for the grid
                const gridContainer = document.createElement('div');
                gridContainer.style.display = 'grid';
                gridContainer.style.gridTemplateColumns = `120px repeat(${NUM_STEPS}, 1fr)`;
                
                tracks.forEach((track, trackIndex) => {
                    // Initialize row in state
                    gridState[trackIndex] = new Array(NUM_STEPS).fill(false);
                    
                    // Track Label
                    const label = document.createElement('div');
                    label.textContent = track.name;
                    label.className = 'track-label text-xs font-semibold p-2 flex items-center justify-center text-center rounded shadow-md cursor-pointer'; // Added cursor-pointer
                    label.dataset.trackIndex = trackIndex; // Add index for preview
                    label.title = 'Click to preview'; // Add tooltip
                    gridContainer.appendChild(label);
                    
                    // Steps
                    for (let stepIndex = 0; stepIndex < NUM_STEPS; stepIndex++) {
                        const btn = document.createElement('button');
                        btn.className = 'seq-btn h-10 w-full rounded';
                        btn.dataset.track = trackIndex;
                        btn.dataset.step = stepIndex;
                        gridContainer.appendChild(btn);
                    }
                });
                
                sequencerGrid.appendChild(gridContainer);
            }

            /**
             * Handles all user interaction event listeners.
             * @param {Array} tracks - The track definitions.
             */
            function setupEventListeners(tracks) {
                // --- Transport Control ---
                playStopButton.addEventListener('click', () => {
                    // Start audio context on first user interaction
                    if (Tone.context.state !== 'running') {
                        Tone.context.resume();
                    }
                    Tone.Transport.toggle();
                    playStopButton.textContent = Tone.Transport.state === 'started' ? 'Stop' : 'Play';
                });

                // --- Sliders ---
                bpmSlider.addEventListener('input', (e) => {
                    Tone.Transport.bpm.value = e.target.value;
                    bpmValue.textContent = e.target.value;
                });
                
                panSlider.addEventListener('input', (e) => {
                    const panVal = parseFloat(e.target.value);
                    masterPanner.pan.value = panVal;
                    
                    if (Math.abs(panVal) < 0.1) panValue.textContent = 'Center';
                    else if (panVal < 0) panValue.textContent = `${Math.abs(panVal * 100).toFixed(0)}% L`;
                    else panValue.textContent = `${(panVal * 100).toFixed(0)}% R`;
                });

                octaveSlider.addEventListener('input', (e) => {
                    const octave = parseInt(e.target.value);
                    octaveValue.textContent = octave;
                    const detune = octave * 1200; // 1200 cents = 1 octave
                    
                    // Apply to all synths
                    tracks.forEach(track => {
                        // FIX: Check if the synth exists and has a 'detune' property
                        if (synths[track.sound] && synths[track.sound].detune) {
                            synths[track.sound].detune.value = detune;
                        }
                    });
                });

                // --- Combined Grid & Label Click Handler ---
                sequencerGrid.addEventListener('click', (e) => {
                    // Start audio context on first user interaction
                    if (Tone.context.state !== 'running') {
                        Tone.context.resume();
                    }

                    // --- Handle Label Click (Preview) ---
                    if (e.target.classList.contains('track-label')) {
                        const trackIndex = e.target.dataset.trackIndex;
                        if (trackIndex === undefined) return;

                        const track = tracks[trackIndex];
                        const sound = synths[track.sound];
                        const time = Tone.now();

                        // Trigger the sound (logic copied from loop)
                        if (track.sound === '808 Kick' || track.sound === '909 Kick') {
                            sound.triggerAttackRelease('C1', '8n', time);
                        } else if (track.sound === '909 Snare' || track.sound === '909 Clap') {
                            sound.triggerAttackRelease('4n', time);
                        } else if (track.sound === '909 Hat-C') {
                            sound.triggerAttackRelease('16n', time);
                        } else if (track.sound === '909 Hat-O') {
                            sound.triggerAttackRelease('8n', time);
                        } else if (track.sound === 'Techno Tom L') {
                            sound.triggerAttackRelease('G1', '8n', time);
                        } else if (track.sound === 'Techno Tom H') {
                            sound.triggerAttackRelease('C2', '8n', time);
                        } else if (track.sound === 'Techno Stab') {
                            sound.triggerAttackRelease('C4', '16n', time);
                        } else if (track.sound === 'Bass') {
                            sound.triggerAttackRelease('C2', '16n', time);
                        }

                        // Visual flash
                        e.target.classList.add('playing');
                        setTimeout(() => e.target.classList.remove('playing'), 150);
                    }

                    // --- Handle Step Button Click ---
                    if (e.target.classList.contains('seq-btn')) {
                        const track = e.target.dataset.track;
                        const step = e.target.dataset.step;
                        
                        // Toggle state
                        gridState[track][step] = !gridState[track][step];
                        
                        // Toggle visual class
                        e.target.classList.toggle('active', gridState[track][step]);
                    }
                });
                
                // --- Sequencer Loop ---
                new Tone.Loop(time => {
                    // 'currentStep' is the one *about* to be played
                    const previousStep = (currentStep - 1 + NUM_STEPS) % NUM_STEPS;
                    
                    // Run in the draw callback to sync visuals
                    Tone.Draw.schedule(() => {
                        // Update visuals for playhead
                        document.querySelectorAll(`.seq-btn[data-step="${currentStep}"]`).forEach(btn => btn.classList.add('playing'));
                        document.querySelectorAll(`.seq-btn[data-step="${previousStep}"]`).forEach(btn => btn.classList.remove('playing'));
                    }, time);

                    
                    // Trigger sounds
                    tracks.forEach((track, trackIndex) => {
                        if (gridState[trackIndex][currentStep]) {
                            // Trigger the sound
                            const sound = synths[track.sound];

                            if (track.sound === '808 Kick' || track.sound === '909 Kick') {
                                sound.triggerAttackRelease('C1', '8n', time);
                            } else if (track.sound === '909 Snare' || track.sound === '909 Clap') {
                                sound.triggerAttackRelease('4n', time);
                            } else if (track.sound === '909 Hat-C') {
                                sound.triggerAttackRelease('16n', time);
                            } else if (track.sound === '909 Hat-O') {
                                sound.triggerAttackRelease('8n', time);
                            } else if (track.sound === 'Techno Tom L') {
                                sound.triggerAttackRelease('G1', '8n', time);
                            } else if (track.sound === 'Techno Tom H') {
                                sound.triggerAttackRelease('C2', '8n', time);
                            } else if (track.sound === 'Techno Stab') {
                                sound.triggerAttackRelease('C4', '16n', time);
                            } else if (track.sound === 'Bass') {
                                sound.triggerAttackRelease('C2', '16n', time);
                            }
                        }
                    });
                    
                    // Increment step
                    currentStep = (currentStep + 1) % NUM_STEPS;
                    
                }, '16n').start(0);
            }

            /**
             * Main initialization function
             */
            async function main() {
                try {
                    const trackDefs = await setupAudio();
                    createGrid(trackDefs);
                    setupEventListeners(trackDefs);
                    
                    // No loading indicator to hide
                    
                    // Set initial BPM
                    Tone.Transport.bpm.value = 120;
                    
                } catch (err) {
                    console.error("Failed to initialize synthesizer:", err);
                    document.body.innerHTML = `<div class="text-red-500 p-8">Error initializing audio. Please refresh. ${err}</div>`;
                }
            }

            main();
        });
    </script>
</body>
</html>

